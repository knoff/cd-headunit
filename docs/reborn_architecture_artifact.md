# Артифакт знаний: Архитектура HeadUnit OS и роль в системе Reborn

Данный документ консолидирует понимание архитектуры репозитория `cd-headunit` и его интеграции в экосистему Reborn. Анализ основан на исходном коде, системных конфигурациях и скриптах сборки.

## 1. Роль и назначение системы

Репозиторий `cd-headunit` определяет **HeadUnit OS (Native Edition)**. Это базовая операционная система для контроллеров кофемашин, выступающая связующим звеном между физическим оборудованием и облачной инфраструктурой Reborn.

**Основные обязанности:**

- **Интеграция с оборудованием:** Управление доступом на уровне ОС к аппаратным интерфейсам.
- **Связность:** Одновременная работа WiFi в двух режимах (клиент для связи с облаком и точка доступа). Точка доступа используется как для первичной настройки, так и для подключения внешнего оборудования (например, кофемолок).
- **Оркестрация сервисов:** Исполнение бизнес-логики (Backend) и шлюзов (Gateway).
- **Надежность:** Обеспечение стабильности системы через неизменяемую (read-only) корневую файловую систему.
- **Управление жизненным циклом:** Координация процесса OTA-обновлений.

---

## 2. Ключевые архитектурные столпы

### А. Нативное исполнение (без контейнеров)

В отличие от облачных подходов, приложения в данной системе запускаются напрямую как **сервисы Systemd**.

- **Эффективность:** Радикальное снижение потребления RAM на ограниченном железе (Raspberry Pi).
- **Прямой доступ:** Упрощение взаимодействия с драйверами и событиями udev.

### Б. Слоистая структура ПО

Система логически разделена на четыре версионируемых слоя:

1. **Слой образа (Image Layer):** Физический файл `.img` (прошивка).
2. **Слой ОС (OS Layer):** База Debian/Raspberry Pi OS + Python + системные утилиты.
3. **Слой сервисов (Services Layer, `services/`):** Общие библиотеки (например, `cd-protocol`), MQTT и управление базами данных.
4. **Слой приложения (App Layer, `src/`):** Бизнес-логика и интерфейс.
   - **Backend:** FastAPI (Python).
   - **Frontend:** React (SPA).
   - **Kiosk:** Режим отображения интерфейса напрямую на экране RPi.

### В. Динамическое связывание (Boot Linker)

Критически важный компонент — **headunit-boot-linker**.

- **Расположение:** `system/bin/headunit-boot-linker.py`, запускается службой `headunit-boot-linker.service`.
- **Функция:** При загрузке сканирует пути `/opt/headunit/factory` и `/data/components` на предмет новейших совместимых версий слоев Services и App, опираясь на `manifest.json`.
- **Механизм:** Создает динамические симлинки в `/run/headunit/active_app` и `/run/headunit/active_services`.
- **Преимущество:** Юниты Systemd используют стабильные пути, что позволяет обновлять код без перенастройки служб.

---

## 3. Отказоустойчивость файловой системы (OverlayFS)

Система использует стратегию **Volatile OverlayFS** для защиты SD-карты и обеспечения стабильного состояния.

- **RO Корень (LowerDir):** Системный раздел на SD-карте примонтирован только для чтения.
- **RAM Overlay (UpperDir):** Все изменения в корне (логи, временные файлы) пишутся в оперативную память (`tmpfs`).
- **Окно персистентности (`/data`):** Выделенный физический раздел (p8), проброшенный сквозь оверлей. Для защиты SD-карты установлено длинное окно сброса кеша на диск (**commit=600**), что необходимо учитывать при сохранении критических данных. Здесь хранятся:
  - `/data/components/`: Обновления OTA.
  - `/data/db/`: Базы данных.
  - `/data/configs/`: Идентификация устройства и серийные номера.

---

## 4. Стратегия обновлений (OTA)

Процесс обновления децентрализован и устойчив:

1. **Доставка:** Пакет `.tar.gz` (с подписью `.sha256`) помещается в `/data/incoming_updates` или на USB-носитель.
2. **Детекция:** `headunit-update-monitor.path` триггерит агент обновления.
3. **Валидация:** `headunit-update-agent.py` проверяет хэш-сумму и манифест.
4. **Установка:** Пакет распаковывается в версионированную папку в `/data/components`.
5. **Активация:** При следующей загрузке `boot-linker` переключает активную версию.

_Примечание: Текущая реализация OTA находится на ранней стадии. Полноценная работа будет обеспечена после интеграции с облачным SaaS-решением Reborn._

---

## 5. Пользовательский интерфейс и Kiosk Mode

Система должна обеспечивать доступ к интерфейсу управления двумя способами:

1. **Внешнее подключение:** Через браузер в локальной сети (или через AP устройства).
2. **Kiosk Mode:** Локальное отображение интерфейса на встроенном экране RPi.
   - Требует настройки OS Layer для запуска графической подсистемы (X11/Wayland) и браузера в режиме киоска.
   - Реализация кастомного загрузочного экрана (Splash Screen) для скрытия системных логов.

---

## 6. Статус разработки и анализ кода

- **Инфраструктура:** Базовая логика загрузки (`system/`) и скелет системы сборки готовы.
- **OTA:** В зачаточном состоянии, ожидает SaaS.
- **Прикладная логика:** Требуется реализация FastAPI бэкенда и React фронтенда в `src/`.
- **UI/UX:** В планах внедрение разделения прав доступа и терминальной прослойки для диагностики.

---

**Примечание:** Данный артифакт предназначен для технического ревью и внесения комментариев командой разработки.
