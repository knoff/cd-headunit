# План оптимизации производительности (INP/CLS)

Цель: снизить INP с 880 мс до <200 мс и CLS с 0.15 до <0.1 на Raspberry Pi 4.

## 1. Исправления Interaction to Next Paint (INP)

### Изоляция состояния (Основной поток)

- **Проблема**: `App.jsx` обновляет свое состояние каждые 100 мс во время симуляции, что вызывает перерисовку всего дерева приложения.
- **Решение**: Вынести `useRealTimeData` и логику симуляции из `App.jsx` в выделенный контекст или локальное состояние внутри `ExtractionMonitor` / `CoffeeGroup`. Обновлять только те компоненты, которые действительно меняются.
- **Решение**: Обернуть `CoffeeGroup`, `MetricRow`, `IconButton` и `DetailedGraph` в `React.memo`, чтобы предотвратить лишние перерисовки.

### Оптимизация переходов и рендеринга

- **Проблема**: CSS-переходы (`transition-all`) для метрик и прогресс-баров длятся 300 мс, в то время как данные приходят каждые 100 мс.
- **Решение**: Отключить CSS-переходы для свойств, которые обновляются чаще, чем раз в 250 мс.
- **Решение**: Обновлять прогресс-бар с помощью `transform: scaleX(...)` вместо `width`, чтобы оставаться в потоке композитора (compositor thread).
- **Решение**: Удалить `backdrop-blur` из `App.jsx` и `SettingsView`. Использовать сплошные цвета или простые полупрозрачные фоны.

### Анимация сетки (Grid)

- **Проблема**: Анимация `grid-template-columns` в `DashboardGrid.jsx` вызывает полный пересчет макета (layout) для всего экрана (2880px).
- **Решение**: Отключить плавные переходы сетки на RPi 4. Использовать мгновенную смену макета или переключиться на более легкую анимацию (например, затухание opacity -> смена макета -> появление).

---

## 2. Исправления Cumulative Layout Shift (CLS)

### Стабильность макета

- **Проблема**: Переходы сетки заставляют соседние элементы постоянно менять размер и «прыгать».
- **Решение**: Удаление анимации сетки (как указано в разделе INP) устранит основной источник CLS.
- **Решение**: Явно задать `aspect-ratio` или `min-height/width` для всех контейнеров, чтобы зарезервировать место до монтирования дочерних элементов.

### Загрузка шрифтов

- **Проблема**: Кастомные шрифты (Inter, Outfit) могут вызывать сдвиги макета при загрузке.
- **Решение**: Использовать `font-display: swap` (уже есть в CSS) и убедиться, что метрики критических шрифтов соответствуют резервным шрифтам.

---

## 3. Этапы реализации

### [Компонент] Состояние и перерисовки

- [ ] Рефакторинг `App.jsx`: перенос логики симуляции в локальный хук/контекст.
- [ ] Применение `React.memo` ко всем «листовым» UI-компонентам (`MetricRow`, `IconButton` и т.д.).

### [Компонент] CSS и стилизация

- [ ] `index.css`: глобально удалить `backdrop-blur` или заменить на высокопроизводительные альтернативы.
- [ ] `DashboardGrid.jsx`: отключить `transition-all` для контейнера сетки.
- [ ] `ExtractionMonitor.jsx`: удалить переходы для `width` и текстовых значений. Использовать `transform` для прогресс-бара.

## 4. Верификация

1. Пересобрать фронтенд.
2. Использовать SSH-туннель для снятия нового профиля Performance.
3. Проверить, что INP < 200 мс и CLS < 0.1.
