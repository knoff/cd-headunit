# Архитектура Файловой Системы (v0.3.0)

## 1. Концепция: Immutable Root (Неизменяемый корень)

HeadUnit OS использует архитектуру **OverlayFS с записью в оперативную память (Volatile Overlay)**. Это обеспечивает максимальную надежность системы и защиту SD-карты от износа.

### Принципы работы

1. **Системный раздел (LowerDir):** Монтируется в режиме **Read-Only**. Физическая запись на него невозможна во время работы. Это гарантирует, что система всегда загружается в чистом, "заводском" состоянии.
2. **Слой изменений (UpperDir):** Находится в **RAM (tmpfs)**. Все изменения, которые система делает в процессе работы (логи, PID-файлы, временные конфиги), пишутся сюда.
3. **Сброс состояния:** При перезагрузке слой изменений (RAM) очищается. Любые изменения в системных файлах (например, `apt install` или правка `/etc/hosts`) будут потеряны.

## 2. Структура Слоев (The Overlay Sandwich)

Система собирается скриптом `overlay-init` на этапе ранней загрузки (initramfs).

```text
Unified Root (/)  <-- То, что видят приложения и Systemd (выглядит как RW)
      |
      +--- [ Write Layer ] ---> RAM (tmpfs)
      |                         (Очищается при ребуте)
      |
      +--- [ Read Layer  ] ---> SD Card Partition (p5 или p6)
                                (Физический Read-Only)
```

## 3. Хранение Данных (Persistence)

Для сохранения данных между перезагрузками используется выделенный раздел `/data` (p8).

### Механизм "Проброса" (Passthrough)

Раздел `/data` монтируется скриптом инициализации **сквозь** оверлей. Это "окно" на физический диск.

| Путь         | Режим записи  | Физическое хранение | Назначение                                         |
| :----------- | :------------ | :------------------ | :------------------------------------------------- |
| `/` (Корень) | RW (Эмуляция) | **RAM**             | Временные файлы, кэши, логи сессии.                |
| `/data`      | RW (Реальный) | **SD Card (p8)**    | Базы данных, настройки пользователя, логи (архив). |
| `/boot`      | RO            | **SD Card (p1)**    | Ядро, config.txt, прошивка.                        |

**Правило разработки:**

> Если данные должны пережить перезагрузку — пишите их в `/data`. Если вы пишете в любое другое место (например, `/home/user`), данные исчезнут после ребута.

## 4. Особенности работы подсистем

### Docker

- **Storage Driver:** Использует `vfs` или `fuse-overlayfs` (так как нативный `overlay2` не работает поверх overlayfs).
- **Images & Containers:** Слои контейнеров хранятся в **RAM** (`/var/lib/docker`).
  - _Плюс:_ Быстрая работа, всегда чистый старт.
  - _Минус:_ Потребление оперативной памяти.
- **Volumes:** Для сохранения данных контейнеров (БД, конфиги) **обязательно** использовать bind-mounts на раздел data:
  ```yaml
  volumes:
    - /data/db:/var/lib/postgresql/data
  ```

### Логирование

- Стандартные логи (`/var/log`) пишутся в RAM. Это предотвращает износ SD-карты.
- Для длительного хранения критических логов необходимо настроить ротацию или экспорт в `/data/logs_archive`.

### Управление памятью (ZRAM)

Так как слой записи живет в оперативной памяти, для предотвращения OOM (Out Of Memory) активирован **ZRAM**.

- **Алгоритм:** `zstd`
- **Объем:** 50% от RAM
- Это позволяет эффективно сжимать текстовые данные (логи, конфиги) в памяти.

## 5. Процесс загрузки (Technical Flow)

1. **Bootloader:** Загружает ядро и `initramfs8`.
2. **Initramfs:**
   - Загружает модуль ядра `overlay`.
   - Запускает скрипт `/scripts/init-bottom/overlay`.
   - Монтирует RO-корень в `/mnt/root-ro`.
   - Монтирует tmpfs в `/mnt/ram-overlay`.
   - Монтирует Data в `/mnt/data`.
   - Объединяет их командой `mount -t overlay ...`.
   - Переносит точку монтирования `/mnt/data` внутрь нового корня (`/new_root/data`).
3. **Switch Root:** Передача управления `systemd`.
4. **Systemd:** Видит корневую ФС как доступную для записи (благодаря RAM-слою) и успешно запускает все службы (`logind`, `NetworkManager`).
