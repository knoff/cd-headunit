# –°–∏—Å—Ç–µ–º–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (QA)

–ü—Ä–æ–µ–∫—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ç—Ä–µ—Ö—É—Ä–æ–≤–Ω–µ–≤—É—é —Å—Ç—Ä–∞—Ç–µ–≥–∏—é –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è –∫–∞—á–µ—Å—Ç–≤–∞ (Triple-Layer QA), —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—É—é –Ω–∞ –±–∞–∑–µ —Ñ—Ä–µ–π–º–≤–æ—Ä–∫–∞ **BATS (Bash Automated Testing System)**.

–≠—Ç–æ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ –æ—à–∏–±–∫–∏ –æ–±–Ω–∞—Ä—É–∂–∏–≤–∞—é—Ç—Å—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ —Ä–∞–Ω–æ: –æ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–æ–¥–∞ —Å–∫—Ä–∏–ø—Ç–æ–≤ –¥–æ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ —Ä–∞–±–æ—Ç–∞—é—â–µ–≥–æ "–∂–µ–ª–µ–∑–∞".

## üèó –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —É—Ä–æ–≤–Ω–µ–π

### –£—Ä–æ–≤–µ–Ω—å 1: Unit Tests (–ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞)

- **–ö–æ–≥–¥–∞:** _–î–æ_ –Ω–∞—á–∞–ª–∞ —Å–±–æ—Ä–∫–∏ –æ–±—Ä–∞–∑–∞.
- **–ì–¥–µ:** –í–Ω—É—Ç—Ä–∏ Docker-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ —Å–±–æ—Ä—â–∏–∫–∞.
- **–ß—Ç–æ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç:** –õ–æ–≥–∏–∫—É bash-–±–∏–±–ª–∏–æ—Ç–µ–∫ (`lib/`), –ø–∞—Ä—Å–µ—Ä—ã –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π, –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞ —Å–∫—Ä–∏–ø—Ç–æ–≤.
- **–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ:** `builder/tests/unit/`
- **–¶–µ–ª—å:** –ù–µ –¥–æ–ø—É—Å—Ç–∏—Ç—å –∑–∞–ø—É—Å–∫–∞ –¥–æ–ª–≥–æ–π —Å–±–æ—Ä–∫–∏, –µ—Å–ª–∏ –≤ —Å–∫—Ä–∏–ø—Ç–∞—Ö –µ—Å—Ç—å –≥–ª—É–ø—ã–µ –æ—à–∏–±–∫–∏.

### –£—Ä–æ–≤–µ–Ω—å 2: Image Tests (–í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–∞)

- **–ö–æ–≥–¥–∞:** –°—Ä–∞–∑—É _–ø–æ—Å–ª–µ_ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Å–±–æ—Ä–∫–∏ `.img` —Ñ–∞–π–ª–∞.
- **–ì–¥–µ:** –ù–∞ —Ö–æ—Å—Ç-–º–∞—à–∏–Ω–µ (—á–µ—Ä–µ–∑ Docker), –º–æ–Ω—Ç–∏—Ä—É—è –ø–æ–ª—É—á–µ–Ω–Ω—ã–π –æ–±—Ä–∞–∑ –∫–∞–∫ loop-device.
- **–ß—Ç–æ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç:**
  - –°—Ç—Ä—É–∫—Ç—É—Ä—É —Ä–∞–∑–¥–µ–ª–æ–≤ (Boot, Root A, Data).
  - –ù–∞–ª–∏—á–∏–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —Ñ–∞–π–ª–æ–≤ (—è–¥—Ä–æ, `health_agent`, –∫–æ–Ω—Ñ–∏–≥–∏).
  - –ü—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –∏ –∏—Å–ø–æ–ª–Ω—è–µ–º–æ—Å—Ç—å –±–∏–Ω–∞—Ä–Ω–∏–∫–æ–≤.
- **–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ:** `builder/tests/image/`
- **–¶–µ–ª—å:** –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –æ–±—Ä–∞–∑ "–∑–∞–ø–µ–∫—Å—è" –ø—Ä–∞–≤–∏–ª—å–Ω–æ, –ø—Ä–µ–∂–¥–µ —á–µ–º –ø—Ä–æ—à–∏–≤–∞—Ç—å –µ–≥–æ –Ω–∞ —Ñ–ª–µ—à–∫—É.

### –£—Ä–æ–≤–µ–Ω—å 3: Runtime Tests (–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –Ω–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ)

- **–ö–æ–≥–¥–∞:** –ù–∞ —Ä–∞–±–æ—Ç–∞—é—â–µ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ (On-Device).
- **–ì–¥–µ:** Raspberry Pi (Target Hardware).
- **–ß—Ç–æ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç:**
  - –°—Ç–∞—Ç—É—Å systemd —Å–µ—Ä–≤–∏—Å–æ–≤ (NetworkManager, D-Bus).
  - –ù–∞–ª–∏—á–∏–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è (Wi-Fi, I2C).
  - –î–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –ø–µ—Ä–∏—Ñ–µ—Ä–∏–∏.
- **–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ –∏—Å—Ö–æ–¥–Ω–∏–∫–æ–≤:** `system/tests/runtime/`
- **–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ –Ω–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ:** `/opt/headunit/tests/runtime/`
- **–¶–µ–ª—å:** –°–∞–º–æ–¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ —Å–∏—Å—Ç–µ–º—ã –≤ –ø–æ–ª—è—Ö.

---

## üöÄ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º (CLI)

–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—Å—É—â–µ—Å—Ç–≤–ª—è–µ—Ç—Å—è —á–µ—Ä–µ–∑ –æ—Å–Ω–æ–≤–Ω–æ–π —Å–∫—Ä–∏–ø—Ç `build.ps1`.

### –ü–æ–ª–Ω—ã–π —Ü–∏–∫–ª (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)

–°–±–æ—Ä–∫–∞ —Å –ø–æ–ª–Ω—ã–º –ø—Ä–æ–≥–æ–Ω–æ–º —Ç–µ—Å—Ç–æ–≤ (Unit -> Build -> Image).

```powershell
.\build.ps1
```

### –ü—Ä–æ–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤

–ï—Å–ª–∏ –Ω—É–∂–Ω–æ –±—ã—Å—Ç—Ä–æ —Å–æ–±—Ä–∞—Ç—å –æ–±—Ä–∞–∑, –∏–≥–Ω–æ—Ä–∏—Ä—É—è –ø—Ä–æ–≤–µ—Ä–∫–∏ (–Ω–µ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è).

```powershell
.\build.ps1 -TestsSkip
```

````markdown
### –ó–∞–ø—É—Å–∫ —Ç–æ–ª—å–∫–æ Unit-—Ç–µ—Å—Ç–æ–≤ (Level 1)

–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø—Ä–∏ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ —Å–∫—Ä–∏–ø—Ç–æ–≤ —Å–±–æ—Ä—â–∏–∫–∞ (`builder/lib/`, `builder/stages/`). –ü–æ–∑–≤–æ–ª—è–µ—Ç –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏–∫—É bash-—Ñ—É–Ω–∫—Ü–∏–π –∑–∞ —Å–µ–∫—É–Ω–¥—ã.

```powershell
.\build.ps1 -Test unit
```
````

### –ó–∞–ø—É—Å–∫ —Ç–æ–ª—å–∫–æ —Ç–µ—Å—Ç–æ–≤ –æ–±—Ä–∞–∑–∞ (Level 2)

–ü–æ–ª–µ–∑–Ω–æ, –µ—Å–ª–∏ –≤—ã —É–∂–µ —Å–æ–±—Ä–∞–ª–∏ –æ–±—Ä–∞–∑, –ø–æ–ø—Ä–∞–≤–∏–ª–∏ —Ç–µ—Å—Ç—ã –∏ —Ö–æ—Ç–∏—Ç–µ –∏—Ö –ø–µ—Ä–µ–ø—Ä–æ–≥–Ω–∞—Ç—å –±–µ–∑ –ø–µ—Ä–µ—Å–±–æ—Ä–∫–∏ –≤—Å–µ–π –û–°.

```powershell
# –¢–µ—Å—Ç–∏—Ä—É–µ—Ç –ø–æ—Å–ª–µ–¥–Ω–∏–π —Å–æ–±—Ä–∞–Ω–Ω—ã–π –æ–±—Ä–∞–∑ (dev/user)
.\build.ps1 -Test current

# –¢–µ—Å—Ç–∏—Ä—É–µ—Ç –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —Ñ–∞–π–ª –æ–±—Ä–∞–∑–∞
.\build.ps1 -Test "path/to/image.img"
```

---

## ü©∫ Runtime Health Agent

–í–Ω—É—Ç—Ä–∏ –û–° —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∞–≥–µ–Ω—Ç `health_agent`, –∫–æ—Ç–æ—Ä—ã–π —è–≤–ª—è–µ—Ç—Å—è –æ–±–µ—Ä—Ç–∫–æ–π –Ω–∞–¥ BATS.

**–ó–∞–ø—É—Å–∫ –Ω–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ (Level 3):**

```bash
# –¢—Ä–µ–±—É—é—Ç—Å—è –ø—Ä–∞–≤–∞ root
sudo health_agent
```

**–ü—Ä–∏–º–µ—Ä –≤—ã–≤–æ–¥–∞:**

```text
>>> HeadUnit Health Check System
Executing tests in: /opt/headunit/tests/runtime

00_smoke.bats
 ‚úì System: CPU info is available
 ‚úì System: User is root

01_services.bats
 ‚úì Core: D-Bus service is active
 ‚úì Network: NetworkManager is active

‚úî All Systems Operational
```

---

## üë®‚Äçüíª –ù–∞–ø–∏—Å–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤

–ú—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —Å–∏–Ω—Ç–∞–∫—Å–∏—Å **BATS**.

**–ü—Ä–∏–º–µ—Ä (`builder/tests/image/99_custom.bats`):**

```bash
#!/usr/bin/env bats

setup() {
    # –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è MOUNT_ROOT –¥–æ—Å—Ç—É–ø–Ω–∞ –≤ Image —Ç–µ—Å—Ç–∞—Ö
    if [ -z "$MOUNT_ROOT" ]; then exit 1; fi
}

@test "Custom: My critical config exists" {
    [ -f "$MOUNT_ROOT/etc/my_app/config.json" ]
}

@test "Custom: Log directory is writable" {
    [ -d "$MOUNT_ROOT/var/log/my_app" ]
    [ -w "$MOUNT_ROOT/var/log/my_app" ]
}
```
