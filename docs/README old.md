# üß≠ –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ –ø–µ—Ä–≤–∏—á–Ω–æ–π —É—Å—Ç–∞–Ω–æ–≤–∫–µ Raspberry Pi (Headunit)

## –í–µ—Ä—Å–∏—è 2.0 ‚Äî A/B + DATA + FACTORY

### üéØ –¶–µ–ª—å

–ù–∞—Å—Ç—Ä–æ–∏—Ç—å Raspberry Pi (–≥–æ–ª–æ–≤–Ω–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –∫–æ—Ñ–µ–º–∞—à–∏–Ω—ã) —Å —Ä–∞–∑–º–µ—Ç–∫–æ–π –¥–∏—Å–∫–∞:

| –†–∞–∑–¥–µ–ª | –ú–µ—Ç–∫–∞      | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ                                | –§–°    | –†–µ–∂–∏–º     | –†–∞–∑–º–µ—Ä           |
| :----- | :--------- | :---------------------------------------- | :---- | :-------- | :--------------- |
| **p1** | `boot`     | –ó–∞–≥—Ä—É–∑–æ—á–Ω—ã–π —Ä–∞–∑–¥–µ–ª                        | FAT32 | `rw`      | 512 MB           |
| **p2** | `rootfs_A` | –û—Å–Ω–æ–≤–Ω–æ–π rootfs (A)                       | ext4  | `rw / ro` | ~6‚Äì8 GB          |
| **p3** | `rootfs_B` | –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π rootfs (B)                 | ext4  | `rw / ro` | ~6‚Äì8 GB          |
| **p4** | `data`     | –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ, Docker, –ª–æ–≥–∏     | ext4  | `rw`      | –æ—Å—Ç–∞–≤—à–µ–µ—Å—è –º–µ—Å—Ç–æ |
| **p5** | `factory`  | –≠—Ç–∞–ª–æ–Ω–Ω—ã–µ –æ–±—Ä–∞–∑—ã –∏ —Å–∫—Ä–∏–ø—Ç—ã –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è | ext4  | **`ro`**  | ~3 GB            |

---

### üß± –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```bash
cd-headunit/
‚îî‚îÄ‚îÄ deploy/
    ‚îú‚îÄ‚îÄ pi-setup/
    ‚îÇ   ‚îú‚îÄ‚îÄ README.md                 # —ç—Ç–æ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ
    ‚îÇ   ‚îú‚îÄ‚îÄ first-boot/
    ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 00_partition_and_clone.sh
    ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ fstab.template
    ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ relocate-data-bind.mounts
    ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ switch_rootfs.sh
    ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ restore_factory.sh
    ‚îÇ   ‚îî‚îÄ‚îÄ factory/                  # (–ø–æ–∫–∞ –ø—É—Å—Ç–æ, –ø–æ—è–≤–∏—Ç—Å—è –ø–æ–∑–∂–µ)
    ‚îî‚îÄ‚îÄ compose/                      # MQTT + Nginx + MinIO (–∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –ø–ª–∞–Ω–∞)
```

---

### ‚öôÔ∏è –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –Ω–∞ Windows

1. **–ó–∞–ø–∏—à–∏—Ç–µ Raspberry Pi OS Lite (64-bit)** —á–µ—Ä–µ–∑ [Raspberry Pi Imager].
   - –í–∫–ª—é—á–∏—Ç–µ SSH, –∑–∞–¥–∞–π—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è/–ø–∞—Ä–æ–ª—å, Wi-Fi (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ) –∏ hostname, –Ω–∞–ø—Ä–∏–º–µ—Ä `headunit`.
2. –ü–æ—Å–ª–µ –∑–∞–ø–∏—Å–∏ –æ—Ç–∫—Ä–æ–µ—Ç—Å—è —Ä–∞–∑–¥–µ–ª `boot`.
   –°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Ç—É–¥–∞:
   - –ü–∞–ø–∫—É first-boot/ –∏–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è.
   - (–ø–æ–∑–∂–µ) factory/rootfs_A.tar.zst ‚Äî –∫–æ–≥–¥–∞ –æ–Ω –ø–æ—è–≤–∏—Ç—Å—è.
   - –ü—É—Å—Ç–æ–π —Ñ–∞–π–ª first-boot.run ‚Äî —Ç—Ä–∏–≥–≥–µ—Ä –ø–µ—Ä–≤–æ–π –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏.

---

### üöÄ –ü–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫

1. –í—Å—Ç–∞–≤—å—Ç–µ microSD –≤ Raspberry Pi –∏ –≤–∫–ª—é—á–∏—Ç–µ –ø–∏—Ç–∞–Ω–∏–µ.
2. –°–∫—Ä–∏–ø—Ç `00_partition_and_clone.sh` –∑–∞–ø—É—Å—Ç–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ (—á–µ—Ä–µ–∑ systemd-unit –∏–ª–∏ `rc.local`) –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç:
   - –ø–µ—Ä–µ—Ä–∞–∑–º–µ—Ç–∫—É –∫–∞—Ä—Ç—ã –ø–∞–º—è—Ç–∏;
   - —Å–æ–∑–¥–∞–Ω–∏–µ A/B rootfs –∏ —Ä–∞–∑–¥–µ–ª–æ–≤ data, factory;
   - –∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ–∫—É—â–µ–π —Å–∏—Å—Ç–µ–º—ã –≤ –æ–±–∞ rootfs;
   - –≥–µ–Ω–µ—Ä–∞—Ü–∏—é fstab –∏ cmdline.txt;
   - –ø–µ—Ä–µ–Ω–æ—Å —Å–∫—Ä–∏–ø—Ç–æ–≤ –≤ –æ–±–∞ rootfs;
   - —Å–æ–∑–¥–∞–Ω–∏–µ –º–∞—Ä–∫–µ—Ä–Ω–æ–≥–æ —Ñ–∞–π–ª–∞ /boot/first-boot.done;
   - –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫—É –≤ –Ω–æ–≤—ã–π —Ä–µ–∂–∏–º A/B.
3. –ü–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ RPi —Ä–∞–±–æ—Ç–∞–µ—Ç —Å –∞–∫—Ç–∏–≤–Ω—ã–º rootfs_A.
   –ü—Ä–æ–≤–µ—Ä–∏—Ç—å:

```bash
lsblk -o NAME,LABEL,SIZE,MOUNTPOINT
cat /boot/cmdline.txt
```

---

### üìÇ –†–∞–∑–¥–µ–ª—ã –ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–π –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏

```bash
NAME        LABEL       SIZE  MOUNTPOINT
mmcblk0p1   boot        512M  /boot
mmcblk0p2   rootfs_A      8G  /
mmcblk0p3   rootfs_B      8G
mmcblk0p4   data         32G  /data
mmcblk0p5   factory        3G  /factory (ro)
```

---

### ‚öôÔ∏è –§–∞–π–ª fstab (–ø—Ä–∏–º–µ—Ä)

```fstab
PARTUUID=<boot>    /boot     vfat  defaults,ro,utf8          0 2
PARTUUID=<rootA>   /         ext4  defaults,noatime          0 1
PARTUUID=<data>    /data     ext4  defaults,noatime          0 2
PARTUUID=<factory> /factory  ext4  ro,noatime                0 2

/data/var_lib_docker  /var/lib/docker  none  bind  0 0
/data/var_log         /var/log         none  bind  0 0
/data/srv             /srv             none  bind  0 0
```

---

### üîÑ –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ A‚ÜîB

```bash
sudo switch_rootfs.sh
sudo reboot
```

–°–∫—Ä–∏–ø—Ç –∏–∑–º–µ–Ω—è–µ—Ç `root=PARTUUID=‚Ä¶` –≤ `/boot/cmdline.txt`, –ø–æ—Å–ª–µ —á–µ–≥–æ –ø—Ä–∏ —Ä–µ–±—É—Ç–µ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –≤—Ç–æ—Ä–∞—è –∫–æ–ø–∏—è.

---

### üõ°Ô∏è –†–∞–∑–¥–µ–ª FACTORY

#### –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ

- –•—Ä–∞–Ω–µ–Ω–∏–µ —ç—Ç–∞–ª–æ–Ω–Ω–æ–≥–æ –æ–±—Ä–∞–∑–∞ rootfs (A –∏–ª–∏ B).
- –¢–æ–ª—å–∫–æ –¥–ª—è —á—Ç–µ–Ω–∏—è –≤ –æ–±—ã—á–Ω–æ–º —Ä–µ–∂–∏–º–µ (fstab ‚Üí ro).
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ —Å–∫—Ä–∏–ø—Ç–æ–º restore_factory.sh.

#### –ß—Ç–æ —Ç–∞–º –±—É–¥–µ—Ç (–ø–æ–∑–∂–µ)

```bash
/factory/
‚îú‚îÄ‚îÄ rootfs_A.tar.zst
‚îú‚îÄ‚îÄ rootfs_A.tar.zst.sha256
‚îî‚îÄ‚îÄ checksums/
```

#### –ü–æ–∫–∞

–†–∞–∑–¥–µ–ª —Å–æ–∑–¥–∞—ë—Ç—Å—è –∏ –º–æ–Ω—Ç–∏—Ä—É–µ—Ç—Å—è –≤ ro, –Ω–æ –ø—É—Å—Ç–æ–π.
–ó–∞–ø–æ–ª–Ω–∏–º –µ–≥–æ –ø–æ–∑–∂–µ, –∫–æ–≥–¥–∞ —Å—Ñ–æ—Ä–º–∏—Ä—É–µ–º —ç—Ç–∞–ª–æ–Ω–Ω—ã–π –æ–±—Ä–∞–∑ (¬´–∑–∞–≤–æ–¥—Å–∫–æ–π¬ª —Å–Ω–∏–º–æ–∫ —Å–∏—Å—Ç–µ–º—ã).

### ‚ôªÔ∏è –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ rootfs –∏–∑ factory

–ö–æ–≥–¥–∞ –ø–æ—è–≤–∏—Ç—Å—è `/factory/rootfs_A.tar.zst`, –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è —Ç–∞–∫:

```bash
sudo restore_factory.sh
sudo reboot
```

–°–∫—Ä–∏–ø—Ç:

- –º–æ–Ω—Ç–∏—Ä—É–µ—Ç `/dev/mmcblk0p2` (`rootfs_A`);
- –ø—Ä–æ–≤–µ—Ä—è–µ—Ç `/factory/rootfs_A.tar.zst`;
- —Ä–∞—Å–ø–∞–∫–æ–≤—ã–≤–∞–µ—Ç –µ–≥–æ —á–µ—Ä–µ–∑ `tar | zstd`;
- —Ä–∞–∑–º–æ–Ω—Ç–∏—Ä—É–µ—Ç –∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ—Ç —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ.

---

### üß∞ –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

- –í—Å–µ –∏–∑–º–µ–Ω—è–µ–º—ã–µ –¥–∞–Ω–Ω—ã–µ (`/var/log`, `/var/lib/docker`, `/srv`) –±–∏–Ω–¥—è—Ç—Å—è –≤ `/data`.
- `rootfs` –º–æ–∂–Ω–æ —Å–º–æ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –≤ `ro` –∏ –ø–æ–≤–µ—Ä—Ö –Ω–µ–≥–æ –¥–æ–±–∞–≤–∏—Ç—å `overlayfs` –¥–ª—è –∑–∞—â–∏—Ç—ã.
- –ü—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ –Ω–∞ OTA-–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è `rootfs` B –º–æ–∂–Ω–æ –ø–µ—Ä–µ–ø—Ä–æ—à–∏–≤–∞—Ç—å –±–µ–∑ —Ä–∏—Å–∫–∞ –ø–æ–≤—Ä–µ–¥–∏—Ç—å —Ç–µ–∫—É—â—É—é —Å–∏—Å—Ç–µ–º—É.
- Factory –Ω–µ –º–æ–¥–∏—Ñ–∏—Ü–∏—Ä—É–µ—Ç—Å—è –≤–æ –≤—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã.

---

### ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Å–ª–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏

```bash
df -h
mount | grep factory
# –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å: type ext4 (ro,...)
sudo systemctl status relocate-data-bind.mounts
```
