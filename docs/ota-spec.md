# Спецификация системы OTA обновлений (v1.0)

Этот документ описывает архитектуру и требования к системе обновлений "по воздуху" (OTA — Over-The-Air) для HeadUnit OS.
На текущем этапе реализуется **Local OTA** (обновление через USB-флешку или прямую загрузку файла).

## 1. Концепция: Двухуровневая система

Система поддерживает два принципиально разных типа обновлений:

### Тип А: Обновление Компонентов (Services / App)

- **Цель:** Быстрая доставка бизнес-логики и фиксов.
- **Механизм:** Side-by-side установка версий в `/data` и переключение симлинков.
- **Особенность:** Не требует перезаписи системного раздела.
- **Статус:** Реализуется в первую очередь (v1.0).

### Тип Б: Обновление ОС (System Image)

- **Цель:** Обновление ядра, драйверов, системных библиотек.
- **Механизм:** **A/B Partitioning**. Запись нового образа в неактивный слот (Root B), перезагрузка в него, проверка работоспособности.
- **Валидация:** Строгая проверка контрольных сумм и успешности старта.
- **Статус:** Запланировано на v2.0.

_Далее в документе детально описывается Тип А, если не указано иное._

## 2. Формат пакетов обновления

### Для компонентов (Тип А)

`headunit-<component>-v<version>.tar.gz`
Плюс файл контрольной суммы: `.sha256` (обязательно).

### Для ОС (Тип Б)

`headunit-os-v<version>.img.gz` (или `.swu` / `.ostree` в будущем).
Аналогично, требуется файл `.sha256`.

---

## 3. Доставка и Обнаружение (Detection)

Источники обновлений:

1. **USB Drive:** Автоматическое обнаружение при монтировании (`udev`).
2. **SSH / Local Drop:** Мониторинг специальной папки `/data/incoming_updates/` (для отладки и пуша через SSH).
3. **Cloud:** (Future) Загрузка через Gateway API.

Агент `headunit-update-agent` мониторит эти источники.

**Структура архива:**
В корне архива должна лежать директория с версией компонента (или содержимое должно распаковываться в неё).
_Важно:_ Для упрощения распаковки, архив должен содержать файлы _внутри_ папки, либо распаковываться в целевую папку.
_Решение:_ Архив содержит "сырые" файлы. Распаковщик создает папку версии.

Обязательный файл: `manifest.json`.

```json
{
  "component": "services",
  "version": "0.5.2",
  "dependencies": {
    "os": ">=0.5.0"
  },
  "compatibility": ["rpi4", "rpi5"] // Опционально: проверка железа
}
```

## ### Lifecycle Тип А (Компоненты)

1. **Detection (Обнаружение):**

   - **USB:** `udev` триггерит агента при монтировании флешки.
   - **Local Drop:** Агент или systemd.path мониторит появление файлов в `/data/incoming_updates/`.
   - **Web/Cloud:** Загрузка через API (в будущем).

2. **Validation (Валидация):**

   - Агент проверяет имя файла.
   - **Checksum:** Проверяет совпадение SHA256 (файл `.sha256` должен лежать рядом).
   - Валидирует структуру архива и целостность (`gzip -t`).
   - Сравнивает версию (защита от даунгрейда, опционально настраиваемая).

3. **Update Mode (Режим обновления):**

   - **Вход:** Система переходит в состояние `UPDATING`.
   - **Эффект:**
     - Блокируется перезагрузка и выключение (через systemd inhibit или lock-файл).
     - Останавливаются управляемые процессы (опционально, чтобы не мусорили в логи/БД).
     - Индикация пользователю (LED / Экран).

4. **Installation (Установка):**

   - Агент распаковывает архив в `/data/components/<component>/<version>/`.
   - Проверяет `manifest.json`.

5. **Finalize (Финализация):**

   - `sync` диска.
   - **Выход** из режима `UPDATING`.
   - Уведомление об успехе.
   - Запрос на перезагрузку (Graceful Reboot).

6. **Activation (Активация):**

   - После ребута `headunit-boot-linker` видит новую версию.
   - Проверяет зависимости (Manifest vs OS Version).
   - Если всё ок — переключает `/run/headunit/active_...`.

7. **Verification (Верификация):**
   - После старта сервисов запускается `health-agent` (или самодиагностика).
   - **Success:** Если ошибок нет в течение N минут — создается флаг валидности (например, `.validated` в папке версии).
   - **Failure:** Если критические ошибки — автоматический или ручной запрос на **Rollback** (удаление папки версии и ребут).

## 4. Агент обновлений (`headunit-update-agent`)

Скрипт на Python/Bash, который выполняет шаги 2-4.

**Расположение:** `/usr/local/bin/headunit-update-agent`
**Использование:**

```bash
# Ручной запуск (Local File)
headunit-update-agent --file /mnt/usb/headunit-app-v1.2.0.tar.gz

# Авто-сканирование (например, при вставке USB)
headunit-update-agent --scan /mnt/usb
```

## 5. Rollback (Откат)

Автоматический откат пока не предусмотрен на уровне `image`.
Ручной откат:

1. Удалить папку с "плохой" версией из `/data/components/...`.
2. Перезагрузиться. Linker выберет предыдущую лучшую версию (или Factory).

## 6. Безопасность

- В v1.0 подпись пакетов не проверяется (Trusted environment).
- В v2.0 планируется GPG подпись и проверка публичным ключом, зашитым в OS.
