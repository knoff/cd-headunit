#!/bin/sh

PREREQ=""
prereqs()
{
    echo "$PREREQ"
}

case $1 in
prereqs)
    prereqs
    exit 0
    ;;
esac

. /scripts/functions

# 1. Загрузка модуля
modprobe overlay

# Ждем диски
wait_for_udev 10

# 2. Поиск раздела DATA (Для проброса, но НЕ для оверлея)
DATA_DEV="/dev/disk/by-label/data"

if [ ! -e "$DATA_DEV" ]; then
    for x in $(cat /proc/cmdline); do
        case $x in
        root=PARTUUID=*)
            UUID="${x#root=PARTUUID=}"
            ROOT_DEV="/dev/disk/by-partuuid/$UUID"
            ;;
        root=/dev/*)
            ROOT_DEV="${x#root=}"
            ;;
        esac
    done

    if [ -L "$ROOT_DEV" ]; then ROOT_DEV=$(readlink -f "$ROOT_DEV"); fi
    DISK_DEV=${ROOT_DEV%p*}
    DATA_DEV="${DISK_DEV}p8"
fi

if [ ! -e "$DATA_DEV" ]; then
    echo "OVERLAY: Data partition not found. System might be unstable."
    # Продолжаем, чтобы хоть как-то загрузиться
fi

# 3. Настройка точек монтирования
RW_MOUNT="/mnt/data"        # Сюда монтируем физический диск Data
RO_MOUNT="/mnt/root-ro"     # Сюда прячем системный RO раздел
RAM_MOUNT="/mnt/ram-overlay" # Сюда монтируем RAM для записи

mkdir -p $RW_MOUNT $RO_MOUNT $RAM_MOUNT

# 4. Монтируем RAM (tmpfs) для записи
# size=50% - половина оперативки под изменения. Можно настроить.
mount -t tmpfs -o size=50%,mode=0755 tmpfs $RAM_MOUNT

# Создаем структуру папок в памяти
UPPER_DIR="$RAM_MOUNT/upper"
WORK_DIR="$RAM_MOUNT/work"
mkdir -p $UPPER_DIR $WORK_DIR

# 5. Монтируем Data (Только для доступа к /data, мимо оверлея)
if [ -e "$DATA_DEV" ]; then
    mount -t ext4 -o noatime,commit=600 $DATA_DEV $RW_MOUNT
fi

# 6. Собираем OverlayFS
# Перемещаем текущий корень в сторону
mount --move ${rootmnt} $RO_MOUNT

# Монтируем оверлей:
# lower = RO диск
# upper = RAM
mount -t overlay overlay -o lowerdir=$RO_MOUNT,upperdir=$UPPER_DIR,workdir=$WORK_DIR ${rootmnt}

# 7. Пробрасываем разделы внутрь новой системы
mkdir -p ${rootmnt}/mnt/root-ro
mkdir -p ${rootmnt}/data

mount --move $RO_MOUNT ${rootmnt}/mnt/root-ro
# Если Data была смонтирована, переносим её в /data внутри системы
if mountpoint -q $RW_MOUNT; then
    mount --move $RW_MOUNT ${rootmnt}/data
fi

exit 0
